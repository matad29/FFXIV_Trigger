<?xml version="1.0"?>
<TriggernometryExport PluginVersion="2.0.2.3">
  <ExportedFolder Id="281c5213-6b54-40ed-ae13-31ae1a0d7d82" Enabled="false" Name="记录岛罐子时间工具" FfxivZoneFilterRegularExpression="^1252$">
    <Triggers>
      <Trigger Enabled="true" Id="e4dc1580-442d-40bd-82c7-05765841afe1" Name="2a.生成口令" RegularExpression="^.{15}\S+ 00:0038::kl$">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="去掉超时数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    int currentHour = now.Hour;&#xD;&#xA;    int currentMinute = now.Minute;&#xD;&#xA;    int currentTotalMinutes = currentHour * 60 + currentMinute;&#xD;&#xA;&#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;数据为空，无需清理&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; validEntries = new List&lt;string&gt;();&#xD;&#xA;&#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4)&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime))&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        int recordHour = recordTime.Hour;&#xD;&#xA;        int recordMinute = recordTime.Minute;&#xD;&#xA;        int recordTotalMinutes = recordHour * 60 + recordMinute;&#xD;&#xA;&#xD;&#xA;        int minuteDiff;&#xD;&#xA;        if (currentTotalMinutes &gt;= recordTotalMinutes)&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = currentTotalMinutes - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = (currentTotalMinutes + 1440) - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (minuteDiff &lt;= 180)&#xD;&#xA;        {&#xD;&#xA;            validEntries.Add(entry);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string cleanedData = string.Join(&quot;;&quot;, validEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = cleanedData,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;数据清理失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="3" Enabled="False" ActionType="Placeholder" Description="去掉重复数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="4" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取当前时间作为参考点&#xD;&#xA;DateTime now = DateTime.Now;&#xD;&#xA;// 定义保留时间范围（例如保留最近12小时内的数据）&#xD;&#xA;TimeSpan keepRange = TimeSpan.FromHours(12);&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string daoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;{&#xD;&#xA;    return;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt; latestEntries = new Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt;();&#xD;&#xA;&#xD;&#xA;foreach (string entry in entries)&#xD;&#xA;{&#xD;&#xA;    string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    if (parts.Length != 4)&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    if (!DateTime.TryParseExact(parts[3].Trim(), &quot;HH:mm&quot;, null, System.Globalization.DateTimeStyles.None, out DateTime entryTime))&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    // 为解析的时间（仅包含时分）添加日期信息&#xD;&#xA;    // 创建基础日期时间（今天的该时间点）&#xD;&#xA;    DateTime entryDateTime = new DateTime(now.Year, now.Month, now.Day, entryTime.Hour, entryTime.Minute, 0);&#xD;&#xA;    &#xD;&#xA;    // 处理跨天情况：如果时间在当前时间之前且超出保留范围，则视为昨天的时间&#xD;&#xA;    if (entryDateTime &gt; now)&#xD;&#xA;    {&#xD;&#xA;        // 如果解析的时间比当前时间晚，说明是昨天的时间&#xD;&#xA;        entryDateTime = entryDateTime.AddDays(-1);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    // 计算与当前时间的差值&#xD;&#xA;    TimeSpan timeDiff = now - entryDateTime;&#xD;&#xA;    &#xD;&#xA;    // 只保留在指定时间范围内的数据&#xD;&#xA;    if (timeDiff &gt; keepRange)&#xD;&#xA;    {&#xD;&#xA;        continue;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string groupKey = parts[1];&#xD;&#xA;    if (!latestEntries.ContainsKey(groupKey))&#xD;&#xA;    {&#xD;&#xA;        latestEntries.Add(groupKey, new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime));&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        if (entryDateTime &gt; latestEntries[groupKey].Value)&#xD;&#xA;        {&#xD;&#xA;            latestEntries[groupKey] = new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;List&lt;string&gt; result = new List&lt;string&gt;();&#xD;&#xA;foreach (var item in latestEntries.Values)&#xD;&#xA;{&#xD;&#xA;    result.Add(item.Key);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string processedData = string.Join(&quot;;&quot;, result);&#xD;&#xA;VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = processedData,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;// 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;" />
          <Action OrderNumber="5" Enabled="False" ActionType="Placeholder" Description="生成口令" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="6" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 简化日志方法，移除冗余命名空间前缀&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;static string EncodeBase62(int value)&#xD;&#xA;{&#xD;&#xA;    const string Base62Chars = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;&#xD;&#xA;    if (value == 0) return &quot;0&quot;;&#xD;&#xA;    &#xD;&#xA;    var result = new Stack&lt;char&gt;();&#xD;&#xA;    while (value &gt; 0)&#xD;&#xA;    {&#xD;&#xA;        result.Push(Base62Chars[value % 62]);&#xD;&#xA;        value /= 62;&#xD;&#xA;    }&#xD;&#xA;    return new string(result.ToArray());&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 获取全局变量存储（对应原GetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; compressedEntries = new List&lt;string&gt;();&#xD;&#xA;    &#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4) continue;&#xD;&#xA;        &#xD;&#xA;        string areaId = parts[0].Trim();&#xD;&#xA;        string islandId = parts[1].Trim();&#xD;&#xA;        &#xD;&#xA;        if (!int.TryParse(parts[2].Trim(), out int northTime)) continue;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime)) continue;&#xD;&#xA;        &#xD;&#xA;        int hour = recordTime.Hour;&#xD;&#xA;        int minute = recordTime.Minute;&#xD;&#xA;        &#xD;&#xA;        string encodedNorthTime = EncodeBase62(northTime);&#xD;&#xA;        string encodedHour = EncodeBase62(hour);&#xD;&#xA;        string encodedMinute = EncodeBase62(minute);&#xD;&#xA;        &#xD;&#xA;        compressedEntries.Add($&quot;{areaId}{islandId}{encodedNorthTime}{encodedHour}{encodedMinute}&quot;);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    if (compressedEntries.Count &gt; 0)&#xD;&#xA;    {&#xD;&#xA;        Log($&quot;#{string.Join(&quot;;&quot;, compressedEntries)}&quot;);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch&#xD;&#xA;{&#xD;&#xA;}" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="eabd0946-6c88-46ee-966e-f2ee906dd951" Name="2b.导入口令" RegularExpression="^.{15}\S+ 00:0038::kl(?&lt;kouling&gt;#([A-Za-z0-9]+)(?:;([A-Za-z0-9]+))*)$" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="导入数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using System.Text.RegularExpressions;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 简化日志方法，移除冗余命名空间前缀&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;static int DecodeBase62(string value)&#xD;&#xA;{&#xD;&#xA;    const string Base62Chars = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;&#xD;&#xA;    int result = 0;&#xD;&#xA;    foreach (char c in value)&#xD;&#xA;    {&#xD;&#xA;        int charIndex = Base62Chars.IndexOf(c);&#xD;&#xA;        if (charIndex == -1)&#xD;&#xA;            throw new ArgumentException($&quot;无效的Base62字符: {c}&quot;);&#xD;&#xA;        result = result * 62 + charIndex;&#xD;&#xA;    }&#xD;&#xA;    return result;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    List&lt;string&gt; daoEntries = new List&lt;string&gt;();&#xD;&#xA;    &#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    if (!string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        string[] existingEntries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        daoEntries.AddRange(existingEntries);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    string password = &quot;${kouling}&quot;;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(password))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;错误：未找到口令数据&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    password = password.Trim();&#xD;&#xA;    if (password[0] != '#')&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;错误：口令格式不正确，必须以#开头&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    string passwordContent = password.Substring(1);&#xD;&#xA;    string[] encodedEntries = passwordContent.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    if (encodedEntries.Length == 0)&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;错误：口令中没有有效条目&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    int successCount = 0;&#xD;&#xA;    int skipCount = 0;&#xD;&#xA;    &#xD;&#xA;    foreach (string encoded in encodedEntries)&#xD;&#xA;    {&#xD;&#xA;        try&#xD;&#xA;        {&#xD;&#xA;            var entryMatch = Regex.Match(encoded, @&quot;^(\d)([A-Za-z0-9]{3})([A-Za-z0-9])([A-Za-z0-9])([A-Za-z0-9])$&quot;);&#xD;&#xA;            if (!entryMatch.Success)&#xD;&#xA;            {&#xD;&#xA;                skipCount++;&#xD;&#xA;                continue;&#xD;&#xA;            }&#xD;&#xA;            &#xD;&#xA;            string areaId = entryMatch.Groups[1].Value;&#xD;&#xA;            string islandId = entryMatch.Groups[2].Value;&#xD;&#xA;            string northTimeCode = entryMatch.Groups[3].Value;&#xD;&#xA;            string hourCode = entryMatch.Groups[4].Value;&#xD;&#xA;            string minuteCode = entryMatch.Groups[5].Value;&#xD;&#xA;            &#xD;&#xA;            int northTime = DecodeBase62(northTimeCode);&#xD;&#xA;            int hour = DecodeBase62(hourCode);&#xD;&#xA;            int minute = DecodeBase62(minuteCode);&#xD;&#xA;            &#xD;&#xA;            if (northTime &lt; 0 || northTime &gt;= 60 || hour &lt; 0 || hour &gt;= 24 || minute &lt; 0 || minute &gt;= 60)&#xD;&#xA;            {&#xD;&#xA;                skipCount++;&#xD;&#xA;                continue;&#xD;&#xA;            }&#xD;&#xA;            &#xD;&#xA;            DateTime recordTime = new DateTime(now.Year, now.Month, now.Day, hour, minute, 0);&#xD;&#xA;            string recordTimeStr = recordTime.ToString(&quot;HH:mm&quot;);&#xD;&#xA;            &#xD;&#xA;            daoEntries.Add($&quot;{areaId},{islandId},{northTime},{recordTimeStr}&quot;);&#xD;&#xA;            successCount++;&#xD;&#xA;        }&#xD;&#xA;        catch&#xD;&#xA;        {&#xD;&#xA;            skipCount++;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    string updatedData = string.Join(&quot;;&quot;, daoEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = updatedData,&#xD;&#xA;        LastChanger = &quot;mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;    &#xD;&#xA;    Log($&quot;处理完成 - 成功导入{successCount}条，跳过{skipCount}条，总计{daoEntries.Count}条数据&quot;);&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;全局处理错误：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="3" Enabled="False" ActionType="Placeholder" Description="去掉超时数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="4" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    int currentHour = now.Hour;&#xD;&#xA;    int currentMinute = now.Minute;&#xD;&#xA;    int currentTotalMinutes = currentHour * 60 + currentMinute;&#xD;&#xA;&#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;数据为空，无需清理&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; validEntries = new List&lt;string&gt;();&#xD;&#xA;&#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4)&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime))&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        int recordHour = recordTime.Hour;&#xD;&#xA;        int recordMinute = recordTime.Minute;&#xD;&#xA;        int recordTotalMinutes = recordHour * 60 + recordMinute;&#xD;&#xA;&#xD;&#xA;        int minuteDiff;&#xD;&#xA;        if (currentTotalMinutes &gt;= recordTotalMinutes)&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = currentTotalMinutes - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = (currentTotalMinutes + 1440) - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (minuteDiff &lt;= 180)&#xD;&#xA;        {&#xD;&#xA;            validEntries.Add(entry);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string cleanedData = string.Join(&quot;;&quot;, validEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = cleanedData,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;数据清理失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="5" Enabled="False" ActionType="Placeholder" Description="去掉重复数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="6" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取当前时间作为参考点&#xD;&#xA;DateTime now = DateTime.Now;&#xD;&#xA;// 定义保留时间范围（例如保留最近12小时内的数据）&#xD;&#xA;TimeSpan keepRange = TimeSpan.FromHours(12);&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string daoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;{&#xD;&#xA;    return;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt; latestEntries = new Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt;();&#xD;&#xA;&#xD;&#xA;foreach (string entry in entries)&#xD;&#xA;{&#xD;&#xA;    string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    if (parts.Length != 4)&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    if (!DateTime.TryParseExact(parts[3].Trim(), &quot;HH:mm&quot;, null, System.Globalization.DateTimeStyles.None, out DateTime entryTime))&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    // 为解析的时间（仅包含时分）添加日期信息&#xD;&#xA;    // 创建基础日期时间（今天的该时间点）&#xD;&#xA;    DateTime entryDateTime = new DateTime(now.Year, now.Month, now.Day, entryTime.Hour, entryTime.Minute, 0);&#xD;&#xA;    &#xD;&#xA;    // 处理跨天情况：如果时间在当前时间之前且超出保留范围，则视为昨天的时间&#xD;&#xA;    if (entryDateTime &gt; now)&#xD;&#xA;    {&#xD;&#xA;        // 如果解析的时间比当前时间晚，说明是昨天的时间&#xD;&#xA;        entryDateTime = entryDateTime.AddDays(-1);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    // 计算与当前时间的差值&#xD;&#xA;    TimeSpan timeDiff = now - entryDateTime;&#xD;&#xA;    &#xD;&#xA;    // 只保留在指定时间范围内的数据&#xD;&#xA;    if (timeDiff &gt; keepRange)&#xD;&#xA;    {&#xD;&#xA;        continue;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string groupKey = parts[1];&#xD;&#xA;    if (!latestEntries.ContainsKey(groupKey))&#xD;&#xA;    {&#xD;&#xA;        latestEntries.Add(groupKey, new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime));&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        if (entryDateTime &gt; latestEntries[groupKey].Value)&#xD;&#xA;        {&#xD;&#xA;            latestEntries[groupKey] = new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;List&lt;string&gt; result = new List&lt;string&gt;();&#xD;&#xA;foreach (var item in latestEntries.Values)&#xD;&#xA;{&#xD;&#xA;    result.Add(item.Key);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string processedData = string.Join(&quot;;&quot;, result);&#xD;&#xA;VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = processedData,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;// 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;" />
          <Action OrderNumber="7" Enabled="False" ActionType="Placeholder" Description="计算数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="8" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using System.Linq;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 定义强类型类，替代 dynamic&#xD;&#xA;public class IslandDisplayItem&#xD;&#xA;{&#xD;&#xA;    public string TypeName { get; set; }&#xD;&#xA;    public string IslandId { get; set; }&#xD;&#xA;    public int FirstTime { get; set; }&#xD;&#xA;    public string TimeDisplay { get; set; }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 获取变量存储（全局：true 对应 dao 变量；非全局：false 对应 listtmp/counttmp 变量）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;    VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    // 替换 dynamic 列表为强类型列表&#xD;&#xA;    var displayList = new List&lt;IslandDisplayItem&gt;();&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4) continue;&#xD;&#xA;&#xD;&#xA;        string typeCode = parts[0].Trim();&#xD;&#xA;        string islandId = parts[1].Trim();&#xD;&#xA;        if (!int.TryParse(parts[2].Trim(), out int northTime)) continue;&#xD;&#xA;        string lastTime = parts[3].Trim(); // 仍保留读取，仅不拼接&#xD;&#xA;&#xD;&#xA;        string typeName = typeMap.TryGetValue(typeCode, out var name) ? name : &quot;未知&quot;;&#xD;&#xA;&#xD;&#xA;        int southTime = (northTime - 30 + 60) % 60;&#xD;&#xA;        int firstTime = Math.Min(northTime, southTime);&#xD;&#xA;        int secondTime = Math.Max(northTime, southTime);&#xD;&#xA;        &#xD;&#xA;        string firstTimeStr = firstTime.ToString(&quot;D2&quot;);&#xD;&#xA;        string secondTimeStr = secondTime.ToString(&quot;D2&quot;);&#xD;&#xA;        &#xD;&#xA;        // 唯一修改处：移除末尾的 -{lastTime} 拼接&#xD;&#xA;        string timeDisplay = $&quot;{firstTimeStr} ({(firstTime == northTime ? &quot;北&quot; : &quot;南&quot;)}) {secondTimeStr} ({(secondTime == northTime ? &quot;北&quot; : &quot;南&quot;)})&quot;;&#xD;&#xA;&#xD;&#xA;        // 添加强类型对象到列表&#xD;&#xA;        displayList.Add(new IslandDisplayItem&#xD;&#xA;        {&#xD;&#xA;            TypeName = typeName,&#xD;&#xA;            IslandId = islandId,&#xD;&#xA;            FirstTime = firstTime,&#xD;&#xA;            TimeDisplay = timeDisplay&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (displayList.Count == 0)&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 按 FirstTime 升序排序&#xD;&#xA;    var sortedList = displayList.OrderBy(item =&gt; item.FirstTime).ToList();&#xD;&#xA;    &#xD;&#xA;    // 计算条目数量&#xD;&#xA;    int itemCount = sortedList.Count;&#xD;&#xA;    &#xD;&#xA;    // 使用回车符连接所有条目为单个字符串&#xD;&#xA;    string listContent = string.Join(Environment.NewLine, sortedList.Select(item =&gt; &#xD;&#xA;        $&quot;{item.TypeName}-{item.IslandId}-{item.TimeDisplay}&quot;));&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 listtmp 变量（非全局）&#xD;&#xA;    VariableScalar listTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = listContent,&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;listtmp&quot;] = listTmpVar;&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 counttmp 变量（存储条目数量，非全局）&#xD;&#xA;    VariableScalar countTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = itemCount.ToString(),&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;counttmp&quot;] = countTmpVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;}" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="d49a68f3-99e7-44c0-9df8-0813672a8aa6" Name="1c.主数据处理" RegularExpression="(?&lt;timestamp&gt;^.{14}) 258 (?&lt;type&gt;102):(?&lt;category&gt;Update):[^:]*:(?&lt;fateId&gt;000007B(8|9)):(?&lt;progress&gt;[^:]*)(?:$|:)" PeriodRefire="Deny" RefirePeriodExpression="60000" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="处理进岛时间" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecutionDelayExpression="500" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原SetScalarVariable(true)，非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 获取当前时间（格式：时:分，如 14:30）&#xD;&#xA;string currentTime = DateTime.Now.ToString(&quot;HH:mm&quot;);&#xD;&#xA;&#xD;&#xA;// 创建并赋值变量&#xD;&#xA;var visitVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = currentTime,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;&#xD;&#xA;// 替换静态助手写法，直接存储变量&#xD;&#xA;globalVarStore.Scalar[&quot;visitlast&quot;] = visitVar;" />
          <Action OrderNumber="3" Enabled="False" ActionType="Placeholder" Description="如果数据全部存在就写入本次数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="4" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（所有变量均为全局，对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取所有需要的变量（替换原静态助手写法）&#xD;&#xA;string areaIdValue = string.Empty;&#xD;&#xA;VariableScalar arealastVar = globalVarStore.GetScalarVariable(&quot;arealast&quot;);&#xD;&#xA;if (arealastVar != null)&#xD;&#xA;{&#xD;&#xA;    areaIdValue = arealastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string daolastValue = string.Empty;&#xD;&#xA;VariableScalar daolastVar = globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;if (daolastVar != null)&#xD;&#xA;{&#xD;&#xA;    daolastValue = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string timelastValue = string.Empty;&#xD;&#xA;VariableScalar timelastVar = globalVarStore.GetScalarVariable(&quot;timelast&quot;);&#xD;&#xA;if (timelastVar != null)&#xD;&#xA;{&#xD;&#xA;    timelastValue = timelastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string visitlastValue = string.Empty;&#xD;&#xA;VariableScalar visitlastVar = globalVarStore.GetScalarVariable(&quot;visitlast&quot;);&#xD;&#xA;if (visitlastVar != null)&#xD;&#xA;{&#xD;&#xA;    visitlastValue = visitlastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string currentDaoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    currentDaoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(daolastValue) &#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;出岛&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;未知岛屿&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !string.IsNullOrEmpty(timelastValue)&#xD;&#xA;    &amp;&amp; !timelastValue.Equals(&quot;未知&quot;, StringComparison.OrdinalIgnoreCase))&#xD;&#xA;{&#xD;&#xA;    string newDaoRecord = $&quot;{areaIdValue},{daolastValue},{timelastValue},{visitlastValue}&quot;;&#xD;&#xA;    string newDaoValue = string.IsNullOrEmpty(currentDaoValue) &#xD;&#xA;        ? newDaoRecord &#xD;&#xA;        : $&quot;{currentDaoValue};{newDaoRecord}&quot;;&#xD;&#xA;&#xD;&#xA;    var newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = newDaoValue,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    // 2. 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}" />
          <Action OrderNumber="5" Enabled="False" ActionType="Placeholder" Description="去掉超时数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="6" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    int currentHour = now.Hour;&#xD;&#xA;    int currentMinute = now.Minute;&#xD;&#xA;    int currentTotalMinutes = currentHour * 60 + currentMinute;&#xD;&#xA;&#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;数据为空，无需清理&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; validEntries = new List&lt;string&gt;();&#xD;&#xA;&#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4)&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime))&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        int recordHour = recordTime.Hour;&#xD;&#xA;        int recordMinute = recordTime.Minute;&#xD;&#xA;        int recordTotalMinutes = recordHour * 60 + recordMinute;&#xD;&#xA;&#xD;&#xA;        int minuteDiff;&#xD;&#xA;        if (currentTotalMinutes &gt;= recordTotalMinutes)&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = currentTotalMinutes - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = (currentTotalMinutes + 1440) - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (minuteDiff &lt;= 180)&#xD;&#xA;        {&#xD;&#xA;            validEntries.Add(entry);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string cleanedData = string.Join(&quot;;&quot;, validEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = cleanedData,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;数据清理失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="7" Enabled="False" ActionType="Placeholder" Description="去掉重复数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="8" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取当前时间作为参考点&#xD;&#xA;DateTime now = DateTime.Now;&#xD;&#xA;// 定义保留时间范围（例如保留最近12小时内的数据）&#xD;&#xA;TimeSpan keepRange = TimeSpan.FromHours(12);&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string daoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;{&#xD;&#xA;    return;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt; latestEntries = new Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt;();&#xD;&#xA;&#xD;&#xA;foreach (string entry in entries)&#xD;&#xA;{&#xD;&#xA;    string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    if (parts.Length != 4)&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    if (!DateTime.TryParseExact(parts[3].Trim(), &quot;HH:mm&quot;, null, System.Globalization.DateTimeStyles.None, out DateTime entryTime))&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    // 为解析的时间（仅包含时分）添加日期信息&#xD;&#xA;    // 创建基础日期时间（今天的该时间点）&#xD;&#xA;    DateTime entryDateTime = new DateTime(now.Year, now.Month, now.Day, entryTime.Hour, entryTime.Minute, 0);&#xD;&#xA;    &#xD;&#xA;    // 处理跨天情况：如果时间在当前时间之前且超出保留范围，则视为昨天的时间&#xD;&#xA;    if (entryDateTime &gt; now)&#xD;&#xA;    {&#xD;&#xA;        // 如果解析的时间比当前时间晚，说明是昨天的时间&#xD;&#xA;        entryDateTime = entryDateTime.AddDays(-1);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    // 计算与当前时间的差值&#xD;&#xA;    TimeSpan timeDiff = now - entryDateTime;&#xD;&#xA;    &#xD;&#xA;    // 只保留在指定时间范围内的数据&#xD;&#xA;    if (timeDiff &gt; keepRange)&#xD;&#xA;    {&#xD;&#xA;        continue;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string groupKey = parts[1];&#xD;&#xA;    if (!latestEntries.ContainsKey(groupKey))&#xD;&#xA;    {&#xD;&#xA;        latestEntries.Add(groupKey, new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime));&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        if (entryDateTime &gt; latestEntries[groupKey].Value)&#xD;&#xA;        {&#xD;&#xA;            latestEntries[groupKey] = new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;List&lt;string&gt; result = new List&lt;string&gt;();&#xD;&#xA;foreach (var item in latestEntries.Values)&#xD;&#xA;{&#xD;&#xA;    result.Add(item.Key);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string processedData = string.Join(&quot;;&quot;, result);&#xD;&#xA;VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = processedData,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;// 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;" />
          <Action OrderNumber="9" Enabled="False" ActionType="Placeholder" Description="计算数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="10" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using System.Linq;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 定义强类型类，替代 dynamic&#xD;&#xA;public class IslandDisplayItem&#xD;&#xA;{&#xD;&#xA;    public string TypeName { get; set; }&#xD;&#xA;    public string IslandId { get; set; }&#xD;&#xA;    public int FirstTime { get; set; }&#xD;&#xA;    public string TimeDisplay { get; set; }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 获取变量存储（全局：true 对应 dao 变量；非全局：false 对应 listtmp/counttmp 变量）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;    VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    // 替换 dynamic 列表为强类型列表&#xD;&#xA;    var displayList = new List&lt;IslandDisplayItem&gt;();&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4) continue;&#xD;&#xA;&#xD;&#xA;        string typeCode = parts[0].Trim();&#xD;&#xA;        string islandId = parts[1].Trim();&#xD;&#xA;        if (!int.TryParse(parts[2].Trim(), out int northTime)) continue;&#xD;&#xA;        string lastTime = parts[3].Trim(); // 仍保留读取，仅不拼接&#xD;&#xA;&#xD;&#xA;        string typeName = typeMap.TryGetValue(typeCode, out var name) ? name : &quot;未知&quot;;&#xD;&#xA;&#xD;&#xA;        int southTime = (northTime - 30 + 60) % 60;&#xD;&#xA;        int firstTime = Math.Min(northTime, southTime);&#xD;&#xA;        int secondTime = Math.Max(northTime, southTime);&#xD;&#xA;        &#xD;&#xA;        string firstTimeStr = firstTime.ToString(&quot;D2&quot;);&#xD;&#xA;        string secondTimeStr = secondTime.ToString(&quot;D2&quot;);&#xD;&#xA;        &#xD;&#xA;        // 唯一修改处：移除末尾的 -{lastTime} 拼接&#xD;&#xA;        string timeDisplay = $&quot;{firstTimeStr} ({(firstTime == northTime ? &quot;北&quot; : &quot;南&quot;)}) {secondTimeStr} ({(secondTime == northTime ? &quot;北&quot; : &quot;南&quot;)})&quot;;&#xD;&#xA;&#xD;&#xA;        // 添加强类型对象到列表&#xD;&#xA;        displayList.Add(new IslandDisplayItem&#xD;&#xA;        {&#xD;&#xA;            TypeName = typeName,&#xD;&#xA;            IslandId = islandId,&#xD;&#xA;            FirstTime = firstTime,&#xD;&#xA;            TimeDisplay = timeDisplay&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (displayList.Count == 0)&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 按 FirstTime 升序排序&#xD;&#xA;    var sortedList = displayList.OrderBy(item =&gt; item.FirstTime).ToList();&#xD;&#xA;    &#xD;&#xA;    // 计算条目数量&#xD;&#xA;    int itemCount = sortedList.Count;&#xD;&#xA;    &#xD;&#xA;    // 使用回车符连接所有条目为单个字符串&#xD;&#xA;    string listContent = string.Join(Environment.NewLine, sortedList.Select(item =&gt; &#xD;&#xA;        $&quot;{item.TypeName}-{item.IslandId}-{item.TimeDisplay}&quot;));&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 listtmp 变量（非全局）&#xD;&#xA;    VariableScalar listTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = listContent,&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;listtmp&quot;] = listTmpVar;&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 counttmp 变量（存储条目数量，非全局）&#xD;&#xA;    VariableScalar countTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = itemCount.ToString(),&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;counttmp&quot;] = countTmpVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;}" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="db3b2107-b4ff-4e78-a3c4-d190860ad8cd" Name="9.出岛" RegularExpression="(?&lt;timestamp&gt;^.{14}) Territory (?&lt;type&gt;01):(?!4E4)(?&lt;id&gt;[^:]+):(?&lt;name&gt;[^:]*)(?:$|:)" RefirePeriodExpression="1000" Sequential="True">
        <Actions>
          <Action OrderNumber="1" ActionType="Variable" VariableOp="SetString" VariableName="dtmp" VariableExpression="出岛" />
          <Action OrderNumber="2" ActionType="Variable" VariableOp="SetString" VariableName="daolast" VariableExpression="出岛" VariablePersist="True" />
          <Action OrderNumber="3" ActionType="Variable" VariableOp="SetString" VariableName="timelast" VariableExpression="未知" VariablePersist="True" />
          <Action OrderNumber="4" ActionType="Trigger" TriggerOp="CancelTrigger" TriggerId="7e3bde11-e150-4b7c-912a-ae500c9806ab" TriggerForce="regexp,conditions,active" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="d6a3bc37-d7fc-47bf-b24b-191361493e8b" Name="1a.记录生成罐子" RegularExpression="(?&lt;timestamp&gt;^.{14}) 258 (?&lt;type&gt;102):(?&lt;category&gt;Add):[^:]*:(?&lt;fateId&gt;000007B(8|9)):(?&lt;progress&gt;[^:]*)(?:$|:)" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="处理进岛时间" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原SetScalarVariable(true)，非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 获取当前时间（格式：时:分，如 14:30）&#xD;&#xA;string currentTime = DateTime.Now.ToString(&quot;HH:mm&quot;);&#xD;&#xA;&#xD;&#xA;// 创建并赋值变量&#xD;&#xA;var visitVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = currentTime,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;&#xD;&#xA;// 替换静态助手写法，直接存储变量&#xD;&#xA;globalVarStore.Scalar[&quot;visitlast&quot;] = visitVar;" />
          <Action OrderNumber="3" Enabled="False" ActionType="Placeholder" Description="处理罐子时间（没有数据情况）" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="4" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;using Triggernometry.Utilities;&#xD;&#xA;&#xD;&#xA;const ushort Target7B8Value = 1976;&#xD;&#xA;const ushort Target7B9Value = 1977;&#xD;&#xA;const ulong FateManagerOffset = 0x29ECCC8;&#xD;&#xA;const ulong ListStartOffset = 0x90;&#xD;&#xA;const ulong ListEndOffset = 0x98;&#xD;&#xA;const ulong FateIdOffset = 0x18;&#xD;&#xA;const ulong TimeStampOffset = 0x20;&#xD;&#xA;&#xD;&#xA;static VariableStore _globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;static void SetTimelast(int minute)&#xD;&#xA;{&#xD;&#xA;    minute = minute % 60;&#xD;&#xA;    if (minute &lt; 0)&#xD;&#xA;    {&#xD;&#xA;        minute += 60;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    var timelastVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = minute.ToString(&quot;D2&quot;),&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    _globalVarStore.Scalar[&quot;timelast&quot;] = timelastVar;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    var baseAddr = Memory.XivBaseAddress;&#xD;&#xA;    if (baseAddr == IntPtr.Zero) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e 错误：获取游戏基地址失败&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong managerPtr = (ulong)baseAddr + FateManagerOffset;&#xD;&#xA;    ulong managerBase = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)managerPtr);&#xD;&#xA;    if (managerBase == 0 || managerBase &lt; 0x100000) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 错误：Fate管理器地址无效，偏移0x{FateManagerOffset:X}可能已过期&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong listStart = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListStartOffset));&#xD;&#xA;    ulong listEnd = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListEndOffset));&#xD;&#xA;    if (listStart == 0 || listEnd == 0 || listStart &gt;= listEnd) return;&#xD;&#xA;&#xD;&#xA;    int count = (int)((listEnd - listStart) / 0x8);&#xD;&#xA;    &#xD;&#xA;    for (int i = 0; i &lt; count; i++)&#xD;&#xA;    {&#xD;&#xA;        ulong fateAddr = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(listStart + (ulong)i * 0x8));&#xD;&#xA;        if (fateAddr == 0 || fateAddr &lt; 0x100000) continue;&#xD;&#xA;        &#xD;&#xA;        ushort memFateId = Memory.Read&lt;ushort&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + FateIdOffset));&#xD;&#xA;        &#xD;&#xA;        if (memFateId == Target7B8Value || memFateId == Target7B9Value)&#xD;&#xA;        {&#xD;&#xA;            int timeStamp = Memory.Read&lt;int&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + TimeStampOffset));&#xD;&#xA;            if (timeStamp &lt;= 0) continue;&#xD;&#xA;            &#xD;&#xA;            DateTime localTime = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)&#xD;&#xA;                .AddSeconds(timeStamp)&#xD;&#xA;                .ToLocalTime();&#xD;&#xA;&#xD;&#xA;            if (memFateId == Target7B8Value)&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 北罐: 记录分钟 {localTime.Minute:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            else&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute + 30);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 南罐: 调整后分钟 {(localTime.Minute + 30) % 60:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            &#xD;&#xA;            break;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 脚本执行异常：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="5" Enabled="False" ActionType="Placeholder" Description="如果数据全部存在就写入本次数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="6" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（所有变量均为全局，对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取所有需要的变量（替换原静态助手写法）&#xD;&#xA;string areaIdValue = string.Empty;&#xD;&#xA;VariableScalar arealastVar = globalVarStore.GetScalarVariable(&quot;arealast&quot;);&#xD;&#xA;if (arealastVar != null)&#xD;&#xA;{&#xD;&#xA;    areaIdValue = arealastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string daolastValue = string.Empty;&#xD;&#xA;VariableScalar daolastVar = globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;if (daolastVar != null)&#xD;&#xA;{&#xD;&#xA;    daolastValue = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string timelastValue = string.Empty;&#xD;&#xA;VariableScalar timelastVar = globalVarStore.GetScalarVariable(&quot;timelast&quot;);&#xD;&#xA;if (timelastVar != null)&#xD;&#xA;{&#xD;&#xA;    timelastValue = timelastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string visitlastValue = string.Empty;&#xD;&#xA;VariableScalar visitlastVar = globalVarStore.GetScalarVariable(&quot;visitlast&quot;);&#xD;&#xA;if (visitlastVar != null)&#xD;&#xA;{&#xD;&#xA;    visitlastValue = visitlastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string currentDaoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    currentDaoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(daolastValue) &#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;出岛&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;未知岛屿&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !string.IsNullOrEmpty(timelastValue)&#xD;&#xA;    &amp;&amp; !timelastValue.Equals(&quot;未知&quot;, StringComparison.OrdinalIgnoreCase))&#xD;&#xA;{&#xD;&#xA;    string newDaoRecord = $&quot;{areaIdValue},{daolastValue},{timelastValue},{visitlastValue}&quot;;&#xD;&#xA;    string newDaoValue = string.IsNullOrEmpty(currentDaoValue) &#xD;&#xA;        ? newDaoRecord &#xD;&#xA;        : $&quot;{currentDaoValue};{newDaoRecord}&quot;;&#xD;&#xA;&#xD;&#xA;    var newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = newDaoValue,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    // 2. 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}" />
          <Action OrderNumber="7" Enabled="False" ActionType="Placeholder" Description="去掉超时数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="8" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    int currentHour = now.Hour;&#xD;&#xA;    int currentMinute = now.Minute;&#xD;&#xA;    int currentTotalMinutes = currentHour * 60 + currentMinute;&#xD;&#xA;&#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;数据为空，无需清理&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; validEntries = new List&lt;string&gt;();&#xD;&#xA;&#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4)&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime))&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        int recordHour = recordTime.Hour;&#xD;&#xA;        int recordMinute = recordTime.Minute;&#xD;&#xA;        int recordTotalMinutes = recordHour * 60 + recordMinute;&#xD;&#xA;&#xD;&#xA;        int minuteDiff;&#xD;&#xA;        if (currentTotalMinutes &gt;= recordTotalMinutes)&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = currentTotalMinutes - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = (currentTotalMinutes + 1440) - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (minuteDiff &lt;= 180)&#xD;&#xA;        {&#xD;&#xA;            validEntries.Add(entry);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string cleanedData = string.Join(&quot;;&quot;, validEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = cleanedData,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;数据清理失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="9" Enabled="False" ActionType="Placeholder" Description="去掉重复数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="10" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取当前时间作为参考点&#xD;&#xA;DateTime now = DateTime.Now;&#xD;&#xA;// 定义保留时间范围（例如保留最近12小时内的数据）&#xD;&#xA;TimeSpan keepRange = TimeSpan.FromHours(12);&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string daoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;{&#xD;&#xA;    return;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt; latestEntries = new Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt;();&#xD;&#xA;&#xD;&#xA;foreach (string entry in entries)&#xD;&#xA;{&#xD;&#xA;    string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    if (parts.Length != 4)&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    if (!DateTime.TryParseExact(parts[3].Trim(), &quot;HH:mm&quot;, null, System.Globalization.DateTimeStyles.None, out DateTime entryTime))&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    // 为解析的时间（仅包含时分）添加日期信息&#xD;&#xA;    // 创建基础日期时间（今天的该时间点）&#xD;&#xA;    DateTime entryDateTime = new DateTime(now.Year, now.Month, now.Day, entryTime.Hour, entryTime.Minute, 0);&#xD;&#xA;    &#xD;&#xA;    // 处理跨天情况：如果时间在当前时间之前且超出保留范围，则视为昨天的时间&#xD;&#xA;    if (entryDateTime &gt; now)&#xD;&#xA;    {&#xD;&#xA;        // 如果解析的时间比当前时间晚，说明是昨天的时间&#xD;&#xA;        entryDateTime = entryDateTime.AddDays(-1);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    // 计算与当前时间的差值&#xD;&#xA;    TimeSpan timeDiff = now - entryDateTime;&#xD;&#xA;    &#xD;&#xA;    // 只保留在指定时间范围内的数据&#xD;&#xA;    if (timeDiff &gt; keepRange)&#xD;&#xA;    {&#xD;&#xA;        continue;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string groupKey = parts[1];&#xD;&#xA;    if (!latestEntries.ContainsKey(groupKey))&#xD;&#xA;    {&#xD;&#xA;        latestEntries.Add(groupKey, new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime));&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        if (entryDateTime &gt; latestEntries[groupKey].Value)&#xD;&#xA;        {&#xD;&#xA;            latestEntries[groupKey] = new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;List&lt;string&gt; result = new List&lt;string&gt;();&#xD;&#xA;foreach (var item in latestEntries.Values)&#xD;&#xA;{&#xD;&#xA;    result.Add(item.Key);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string processedData = string.Join(&quot;;&quot;, result);&#xD;&#xA;VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = processedData,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;// 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;" />
          <Action OrderNumber="11" Enabled="False" ActionType="Placeholder" Description="计算数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="12" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using System.Linq;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 定义强类型类，替代 dynamic&#xD;&#xA;public class IslandDisplayItem&#xD;&#xA;{&#xD;&#xA;    public string TypeName { get; set; }&#xD;&#xA;    public string IslandId { get; set; }&#xD;&#xA;    public int FirstTime { get; set; }&#xD;&#xA;    public string TimeDisplay { get; set; }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 获取变量存储（全局：true 对应 dao 变量；非全局：false 对应 listtmp/counttmp 变量）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;    VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    // 替换 dynamic 列表为强类型列表&#xD;&#xA;    var displayList = new List&lt;IslandDisplayItem&gt;();&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4) continue;&#xD;&#xA;&#xD;&#xA;        string typeCode = parts[0].Trim();&#xD;&#xA;        string islandId = parts[1].Trim();&#xD;&#xA;        if (!int.TryParse(parts[2].Trim(), out int northTime)) continue;&#xD;&#xA;        string lastTime = parts[3].Trim(); // 仍保留读取，仅不拼接&#xD;&#xA;&#xD;&#xA;        string typeName = typeMap.TryGetValue(typeCode, out var name) ? name : &quot;未知&quot;;&#xD;&#xA;&#xD;&#xA;        int southTime = (northTime - 30 + 60) % 60;&#xD;&#xA;        int firstTime = Math.Min(northTime, southTime);&#xD;&#xA;        int secondTime = Math.Max(northTime, southTime);&#xD;&#xA;        &#xD;&#xA;        string firstTimeStr = firstTime.ToString(&quot;D2&quot;);&#xD;&#xA;        string secondTimeStr = secondTime.ToString(&quot;D2&quot;);&#xD;&#xA;        &#xD;&#xA;        // 唯一修改处：移除末尾的 -{lastTime} 拼接&#xD;&#xA;        string timeDisplay = $&quot;{firstTimeStr} ({(firstTime == northTime ? &quot;北&quot; : &quot;南&quot;)}) {secondTimeStr} ({(secondTime == northTime ? &quot;北&quot; : &quot;南&quot;)})&quot;;&#xD;&#xA;&#xD;&#xA;        // 添加强类型对象到列表&#xD;&#xA;        displayList.Add(new IslandDisplayItem&#xD;&#xA;        {&#xD;&#xA;            TypeName = typeName,&#xD;&#xA;            IslandId = islandId,&#xD;&#xA;            FirstTime = firstTime,&#xD;&#xA;            TimeDisplay = timeDisplay&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (displayList.Count == 0)&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 按 FirstTime 升序排序&#xD;&#xA;    var sortedList = displayList.OrderBy(item =&gt; item.FirstTime).ToList();&#xD;&#xA;    &#xD;&#xA;    // 计算条目数量&#xD;&#xA;    int itemCount = sortedList.Count;&#xD;&#xA;    &#xD;&#xA;    // 使用回车符连接所有条目为单个字符串&#xD;&#xA;    string listContent = string.Join(Environment.NewLine, sortedList.Select(item =&gt; &#xD;&#xA;        $&quot;{item.TypeName}-{item.IslandId}-{item.TimeDisplay}&quot;));&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 listtmp 变量（非全局）&#xD;&#xA;    VariableScalar listTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = listContent,&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;listtmp&quot;] = listTmpVar;&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 counttmp 变量（存储条目数量，非全局）&#xD;&#xA;    VariableScalar countTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = itemCount.ToString(),&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;counttmp&quot;] = countTmpVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;}" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="ab9cab9b-1a82-4366-b2d6-d1812666136f" Name="1b.记录更新罐子" RegularExpression="(?&lt;timestamp&gt;^.{14}) 258 (?&lt;type&gt;102):(?&lt;category&gt;Update):[^:]*:(?&lt;fateId&gt;000007B(8|9)):(?&lt;progress&gt;[^:]*)(?:$|:)" PeriodRefire="Deny" RefirePeriodExpression="60000" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="处理罐子时间（没有数据情况）" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;using Triggernometry.Utilities;&#xD;&#xA;&#xD;&#xA;const ushort Target7B8Value = 1976;&#xD;&#xA;const ushort Target7B9Value = 1977;&#xD;&#xA;const ulong FateManagerOffset = 0x29ECCC8;&#xD;&#xA;const ulong ListStartOffset = 0x90;&#xD;&#xA;const ulong ListEndOffset = 0x98;&#xD;&#xA;const ulong FateIdOffset = 0x18;&#xD;&#xA;const ulong TimeStampOffset = 0x20;&#xD;&#xA;&#xD;&#xA;static VariableStore _globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;static void SetTimelast(int minute)&#xD;&#xA;{&#xD;&#xA;    minute = minute % 60;&#xD;&#xA;    if (minute &lt; 0)&#xD;&#xA;    {&#xD;&#xA;        minute += 60;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    var timelastVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = minute.ToString(&quot;D2&quot;),&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    _globalVarStore.Scalar[&quot;timelast&quot;] = timelastVar;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    var baseAddr = Memory.XivBaseAddress;&#xD;&#xA;    if (baseAddr == IntPtr.Zero) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e 错误：获取游戏基地址失败&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong managerPtr = (ulong)baseAddr + FateManagerOffset;&#xD;&#xA;    ulong managerBase = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)managerPtr);&#xD;&#xA;    if (managerBase == 0 || managerBase &lt; 0x100000) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 错误：Fate管理器地址无效，偏移0x{FateManagerOffset:X}可能已过期&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong listStart = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListStartOffset));&#xD;&#xA;    ulong listEnd = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListEndOffset));&#xD;&#xA;    if (listStart == 0 || listEnd == 0 || listStart &gt;= listEnd) return;&#xD;&#xA;&#xD;&#xA;    int count = (int)((listEnd - listStart) / 0x8);&#xD;&#xA;    &#xD;&#xA;    for (int i = 0; i &lt; count; i++)&#xD;&#xA;    {&#xD;&#xA;        ulong fateAddr = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(listStart + (ulong)i * 0x8));&#xD;&#xA;        if (fateAddr == 0 || fateAddr &lt; 0x100000) continue;&#xD;&#xA;        &#xD;&#xA;        ushort memFateId = Memory.Read&lt;ushort&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + FateIdOffset));&#xD;&#xA;        &#xD;&#xA;        if (memFateId == Target7B8Value || memFateId == Target7B9Value)&#xD;&#xA;        {&#xD;&#xA;            int timeStamp = Memory.Read&lt;int&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + TimeStampOffset));&#xD;&#xA;            if (timeStamp &lt;= 0) continue;&#xD;&#xA;            &#xD;&#xA;            DateTime localTime = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)&#xD;&#xA;                .AddSeconds(timeStamp)&#xD;&#xA;                .ToLocalTime();&#xD;&#xA;&#xD;&#xA;            if (memFateId == Target7B8Value)&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 北罐: 记录分钟 {localTime.Minute:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            else&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute + 30);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 南罐: 调整后分钟 {(localTime.Minute + 30) % 60:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            &#xD;&#xA;            break;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 脚本执行异常：{ex.Message}&quot;);&#xD;&#xA;}" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="2911194b-bf8d-4688-9d5a-d305de0dfdf4" Name="0a.进岛" RegularExpression="(?&lt;timestamp&gt;^.{14}) Territory (?&lt;type&gt;01):(?&lt;id&gt;4E4):(?&lt;name&gt;[^:]*)(?:$|:)" RefirePeriodExpression="1000" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="获取临时变量" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="Trigger" TriggerOp="CancelTrigger" TriggerId="7e3bde11-e150-4b7c-912a-ae500c9806ab" TriggerForce="regexp,conditions,active" />
          <Action OrderNumber="3" ActionType="Variable" VariableOp="SetString" VariableName="daotmp" VariableExpression="${_entity[PosX=809.0001&amp;&amp;bnpcid=18314].id}" />
          <Action OrderNumber="4" ActionType="Variable" VariableOp="SetString" VariableName="areatmp" VariableExpression="${_me.CurrentWorldID}" />
          <Action OrderNumber="5" Enabled="False" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Linq;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;using Triggernometry.Expressions.Maths;&#xD;&#xA;using Triggernometry.Utilities;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;// 第一步：获取指定地址的数据&#xD;&#xA;IntPtr meAddress = (IntPtr)${_me.Address};&#xD;&#xA;IntPtr finalAddress = (IntPtr)(meAddress + 0x2360);&#xD;&#xA;var readData = Memory.Read&lt;ushort&gt;(Memory.XivProcHandle, finalAddress);&#xD;&#xA;&#xD;&#xA;// 第二步：写入areatmp变量（严格按你的示例写法）&#xD;&#xA;VariableStore targetVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;VariableScalar newAreatmpVar = new VariableScalar();&#xD;&#xA;newAreatmpVar.Value = readData.ToString();&#xD;&#xA;newAreatmpVar.LastChanger = &quot;Mata&quot;;&#xD;&#xA;newAreatmpVar.LastChanged = DateTime.Now;&#xD;&#xA;targetVarStore.Scalar[&quot;areatmp&quot;] = newAreatmpVar;" VariableOp="SetString" VariableName="areaidtmp" VariableExpression="${_me.Address}" />
          <Action OrderNumber="6" Enabled="False" ActionType="Placeholder" Description="处理岛ID" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="7" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;const string Base62Chars = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;&#xD;&#xA;&#xD;&#xA;// 获取变量存储（全局：true，与原SetScalarVariable(true)对应；非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取 daotmp 变量（替换原静态助手写法）&#xD;&#xA;string entityId = string.Empty;&#xD;&#xA;VariableScalar daotmpVar = localVarStore.GetScalarVariable(&quot;daotmp&quot;);&#xD;&#xA;if (daotmpVar != null)&#xD;&#xA;{&#xD;&#xA;    entityId = daotmpVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(entityId) &#xD;&#xA;    &amp;&amp; entityId != &quot;0&quot; &#xD;&#xA;    &amp;&amp; entityId.Length == 8 &#xD;&#xA;    &amp;&amp; entityId.StartsWith(&quot;40&quot;, StringComparison.OrdinalIgnoreCase))&#xD;&#xA;{&#xD;&#xA;    try&#xD;&#xA;    {&#xD;&#xA;        ulong hexValue = ulong.Parse(entityId, System.Globalization.NumberStyles.HexNumber);&#xD;&#xA;        ulong adjustedValue = hexValue - 0x40000000;&#xD;&#xA;        &#xD;&#xA;        string base62Code = adjustedValue == 0 ? Base62Chars[0].ToString() : &quot;&quot;;&#xD;&#xA;        var temp = adjustedValue;&#xD;&#xA;        while (temp &gt; 0)&#xD;&#xA;        {&#xD;&#xA;            base62Code = Base62Chars[(int)(temp % 62)] + base62Code;&#xD;&#xA;            temp /= 62;&#xD;&#xA;        }&#xD;&#xA;        &#xD;&#xA;        string daolast;&#xD;&#xA;        if (base62Code.Length &lt; 3)&#xD;&#xA;        {&#xD;&#xA;            daolast = base62Code.PadLeft(3, Base62Chars[0]);&#xD;&#xA;        }&#xD;&#xA;        else if (base62Code.Length &gt; 3)&#xD;&#xA;        {&#xD;&#xA;            daolast = base62Code.Substring(base62Code.Length - 3);&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            daolast = base62Code;&#xD;&#xA;        }&#xD;&#xA;        &#xD;&#xA;        // 2. 安全设置 daolast 变量（替换原静态助手写法）&#xD;&#xA;        VariableScalar daolastVar = new VariableScalar&#xD;&#xA;        {&#xD;&#xA;            Value = daolast,&#xD;&#xA;            LastChanger = &quot;Mata&quot;,&#xD;&#xA;            LastChanged = DateTime.Now&#xD;&#xA;        };&#xD;&#xA;        globalVarStore.Scalar[&quot;daolast&quot;] = daolastVar;&#xD;&#xA;    }&#xD;&#xA;    catch (Exception ex)&#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 生成daolast失败：{ex.Message}&quot;);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;else&#xD;&#xA;{&#xD;&#xA;    // 3. 设置默认值（未知岛屿）&#xD;&#xA;    VariableScalar unknownVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = &quot;未知岛屿&quot;,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    globalVarStore.Scalar[&quot;daolast&quot;] = unknownVar;&#xD;&#xA;}" />
          <Action OrderNumber="8" Enabled="False" ActionType="Placeholder" Description="处理区服" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="9" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static readonly Dictionary&lt;int, int&gt; WorldIdToAreaIdMap = new Dictionary&lt;int, int&gt;()&#xD;&#xA;{&#xD;&#xA;    { 1042, 1 }, { 1043, 3 }, { 1044, 1 }, { 1045, 3 }, { 1081, 1 },&#xD;&#xA;    { 1106, 3 }, { 1060, 1 }, { 1169, 3 }, { 1167, 1 }, { 1170, 2 },&#xD;&#xA;    { 1171, 2 }, { 1172, 2 }, { 1076, 2 }, { 1113, 2 }, { 1166, 2 },&#xD;&#xA;    { 1121, 2 }, { 1173, 1 }, { 1174, 1 }, { 1175, 1 }, { 1177, 3 },&#xD;&#xA;    { 1178, 3 }, { 1179, 3 }, { 1176, 2 }, { 1192, 4 }, { 1183, 4 },&#xD;&#xA;    { 1180, 4 }, { 1186, 4 }, { 1201, 4 }&#xD;&#xA;};&#xD;&#xA;&#xD;&#xA;// 获取变量存储（非全局：false 对应原GetScalarVariable(false)；全局：true 对应原SetScalarVariable(true)）&#xD;&#xA;VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 areatmp 变量（替换原静态助手写法）&#xD;&#xA;string worldIdStr = string.Empty;&#xD;&#xA;VariableScalar areatmpVar = localVarStore.GetScalarVariable(&quot;areatmp&quot;);&#xD;&#xA;if (areatmpVar != null)&#xD;&#xA;{&#xD;&#xA;    worldIdStr = areatmpVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    if (int.TryParse(worldIdStr, out int worldId))&#xD;&#xA;    {&#xD;&#xA;        if (WorldIdToAreaIdMap.TryGetValue(worldId, out int areaId))&#xD;&#xA;        {&#xD;&#xA;            var areaVar = new VariableScalar&#xD;&#xA;            {&#xD;&#xA;                Value = areaId.ToString(),&#xD;&#xA;                LastChanger = &quot;Mata&quot;,&#xD;&#xA;                LastChanged = DateTime.Now&#xD;&#xA;            };&#xD;&#xA;            // 安全设置 arealast 变量（替换原静态助手写法）&#xD;&#xA;            globalVarStore.Scalar[&quot;arealast&quot;] = areaVar;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 处理worldId失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="10" Enabled="False" ActionType="Placeholder" Description="处理进岛时间" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="11" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原SetScalarVariable(true)，非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 获取当前时间（格式：时:分，如 14:30）&#xD;&#xA;string currentTime = DateTime.Now.ToString(&quot;HH:mm&quot;);&#xD;&#xA;&#xD;&#xA;// 创建并赋值变量&#xD;&#xA;var visitVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = currentTime,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;&#xD;&#xA;// 替换静态助手写法，直接存储变量&#xD;&#xA;globalVarStore.Scalar[&quot;visitlast&quot;] = visitVar;" />
          <Action OrderNumber="12" Enabled="False" ActionType="Placeholder" Description="处理罐子时间（已有数据情况）" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="13" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)，非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string currentDaoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    currentDaoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;// 2. 安全获取 daolast 变量（替换原静态助手写法）&#xD;&#xA;string targetDaolast = string.Empty;&#xD;&#xA;VariableScalar daolastVar = globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;if (daolastVar != null)&#xD;&#xA;{&#xD;&#xA;    targetDaolast = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(currentDaoValue) &amp;&amp; !string.IsNullOrEmpty(targetDaolast))&#xD;&#xA;{&#xD;&#xA;    string[] daoRecords = currentDaoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string record in daoRecords)&#xD;&#xA;    {&#xD;&#xA;        string[] recordParts = record.Split(new[] { ',' }, StringSplitOptions.None);&#xD;&#xA;        &#xD;&#xA;        if (recordParts.Length &gt;= 4 &amp;&amp; recordParts[1] == targetDaolast)&#xD;&#xA;        {&#xD;&#xA;            if (!string.IsNullOrEmpty(recordParts[2]))&#xD;&#xA;            {&#xD;&#xA;                var timelastVar = new VariableScalar&#xD;&#xA;                {&#xD;&#xA;                    Value = recordParts[2],&#xD;&#xA;                    LastChanger = &quot;Mata&quot;,&#xD;&#xA;                    LastChanged = DateTime.Now&#xD;&#xA;                };&#xD;&#xA;                // 3. 安全设置 timelast 变量（替换原静态助手写法）&#xD;&#xA;                globalVarStore.Scalar[&quot;timelast&quot;] = timelastVar;&#xD;&#xA;            }&#xD;&#xA;            break;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}" />
          <Action OrderNumber="14" Enabled="False" ActionType="Placeholder" Description="处理罐子时间（没有数据情况）" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="15" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;using Triggernometry.Utilities;&#xD;&#xA;&#xD;&#xA;const ushort Target7B8Value = 1976;&#xD;&#xA;const ushort Target7B9Value = 1977;&#xD;&#xA;const ulong FateManagerOffset = 0x29ECCC8;&#xD;&#xA;const ulong ListStartOffset = 0x90;&#xD;&#xA;const ulong ListEndOffset = 0x98;&#xD;&#xA;const ulong FateIdOffset = 0x18;&#xD;&#xA;const ulong TimeStampOffset = 0x20;&#xD;&#xA;&#xD;&#xA;static VariableStore _globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;static void SetTimelast(int minute)&#xD;&#xA;{&#xD;&#xA;    minute = minute % 60;&#xD;&#xA;    if (minute &lt; 0)&#xD;&#xA;    {&#xD;&#xA;        minute += 60;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    var timelastVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = minute.ToString(&quot;D2&quot;),&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    _globalVarStore.Scalar[&quot;timelast&quot;] = timelastVar;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    var baseAddr = Memory.XivBaseAddress;&#xD;&#xA;    if (baseAddr == IntPtr.Zero) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e 错误：获取游戏基地址失败&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong managerPtr = (ulong)baseAddr + FateManagerOffset;&#xD;&#xA;    ulong managerBase = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)managerPtr);&#xD;&#xA;    if (managerBase == 0 || managerBase &lt; 0x100000) &#xD;&#xA;    {&#xD;&#xA;        RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 错误：Fate管理器地址无效，偏移0x{FateManagerOffset:X}可能已过期&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    ulong listStart = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListStartOffset));&#xD;&#xA;    ulong listEnd = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(managerBase + ListEndOffset));&#xD;&#xA;    if (listStart == 0 || listEnd == 0 || listStart &gt;= listEnd) return;&#xD;&#xA;&#xD;&#xA;    int count = (int)((listEnd - listStart) / 0x8);&#xD;&#xA;    &#xD;&#xA;    for (int i = 0; i &lt; count; i++)&#xD;&#xA;    {&#xD;&#xA;        ulong fateAddr = Memory.Read&lt;ulong&gt;(Memory.XivProcHandle, (IntPtr)(listStart + (ulong)i * 0x8));&#xD;&#xA;        if (fateAddr == 0 || fateAddr &lt; 0x100000) continue;&#xD;&#xA;        &#xD;&#xA;        ushort memFateId = Memory.Read&lt;ushort&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + FateIdOffset));&#xD;&#xA;        &#xD;&#xA;        if (memFateId == Target7B8Value || memFateId == Target7B9Value)&#xD;&#xA;        {&#xD;&#xA;            int timeStamp = Memory.Read&lt;int&gt;(Memory.XivProcHandle, (IntPtr)(fateAddr + TimeStampOffset));&#xD;&#xA;            if (timeStamp &lt;= 0) continue;&#xD;&#xA;            &#xD;&#xA;            DateTime localTime = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)&#xD;&#xA;                .AddSeconds(timeStamp)&#xD;&#xA;                .ToLocalTime();&#xD;&#xA;&#xD;&#xA;            if (memFateId == Target7B8Value)&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 北罐: 记录分钟 {localTime.Minute:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            else&#xD;&#xA;            {&#xD;&#xA;                SetTimelast(localTime.Minute + 30);&#xD;&#xA;                RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 检测到Fate 南罐: 调整后分钟 {(localTime.Minute + 30) % 60:D2}&quot;);&#xD;&#xA;            }&#xD;&#xA;            &#xD;&#xA;            break;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e 脚本执行异常：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="16" Enabled="False" ActionType="Placeholder" Description="如果数据全部存在就写入本次数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="17" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（所有变量均为全局，对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取所有需要的变量（替换原静态助手写法）&#xD;&#xA;string areaIdValue = string.Empty;&#xD;&#xA;VariableScalar arealastVar = globalVarStore.GetScalarVariable(&quot;arealast&quot;);&#xD;&#xA;if (arealastVar != null)&#xD;&#xA;{&#xD;&#xA;    areaIdValue = arealastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string daolastValue = string.Empty;&#xD;&#xA;VariableScalar daolastVar = globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;if (daolastVar != null)&#xD;&#xA;{&#xD;&#xA;    daolastValue = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string timelastValue = string.Empty;&#xD;&#xA;VariableScalar timelastVar = globalVarStore.GetScalarVariable(&quot;timelast&quot;);&#xD;&#xA;if (timelastVar != null)&#xD;&#xA;{&#xD;&#xA;    timelastValue = timelastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string visitlastValue = string.Empty;&#xD;&#xA;VariableScalar visitlastVar = globalVarStore.GetScalarVariable(&quot;visitlast&quot;);&#xD;&#xA;if (visitlastVar != null)&#xD;&#xA;{&#xD;&#xA;    visitlastValue = visitlastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string currentDaoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    currentDaoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(daolastValue) &#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;出岛&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !daolastValue.Equals(&quot;未知岛屿&quot;, StringComparison.OrdinalIgnoreCase)&#xD;&#xA;    &amp;&amp; !string.IsNullOrEmpty(timelastValue)&#xD;&#xA;    &amp;&amp; !timelastValue.Equals(&quot;未知&quot;, StringComparison.OrdinalIgnoreCase))&#xD;&#xA;{&#xD;&#xA;    string newDaoRecord = $&quot;{areaIdValue},{daolastValue},{timelastValue},{visitlastValue}&quot;;&#xD;&#xA;    string newDaoValue = string.IsNullOrEmpty(currentDaoValue) &#xD;&#xA;        ? newDaoRecord &#xD;&#xA;        : $&quot;{currentDaoValue};{newDaoRecord}&quot;;&#xD;&#xA;&#xD;&#xA;    var newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = newDaoValue,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    // 2. 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}" />
          <Action OrderNumber="18" Enabled="False" ActionType="Placeholder" Description="去掉超时数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="19" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;static void Log(string msg) =&gt; RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, &quot;/e &quot; + msg);&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    DateTime now = DateTime.Now;&#xD;&#xA;    int currentHour = now.Hour;&#xD;&#xA;    int currentMinute = now.Minute;&#xD;&#xA;    int currentTotalMinutes = currentHour * 60 + currentMinute;&#xD;&#xA;&#xD;&#xA;    // 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        Log(&quot;数据为空，无需清理&quot;);&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    List&lt;string&gt; validEntries = new List&lt;string&gt;();&#xD;&#xA;&#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4)&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        if (!DateTime.TryParse(parts[3].Trim(), out DateTime recordTime))&#xD;&#xA;            continue;&#xD;&#xA;&#xD;&#xA;        int recordHour = recordTime.Hour;&#xD;&#xA;        int recordMinute = recordTime.Minute;&#xD;&#xA;        int recordTotalMinutes = recordHour * 60 + recordMinute;&#xD;&#xA;&#xD;&#xA;        int minuteDiff;&#xD;&#xA;        if (currentTotalMinutes &gt;= recordTotalMinutes)&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = currentTotalMinutes - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            minuteDiff = (currentTotalMinutes + 1440) - recordTotalMinutes;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (minuteDiff &lt;= 180)&#xD;&#xA;        {&#xD;&#xA;            validEntries.Add(entry);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string cleanedData = string.Join(&quot;;&quot;, validEntries);&#xD;&#xA;    VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = cleanedData,&#xD;&#xA;        LastChanger = &quot;Mata&quot;,&#xD;&#xA;        LastChanged = now&#xD;&#xA;    };&#xD;&#xA;    // 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;    globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    Log($&quot;数据清理失败：{ex.Message}&quot;);&#xD;&#xA;}" />
          <Action OrderNumber="20" Enabled="False" ActionType="Placeholder" Description="去掉重复数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="21" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取当前时间作为参考点&#xD;&#xA;DateTime now = DateTime.Now;&#xD;&#xA;// 定义保留时间范围（例如保留最近12小时内的数据）&#xD;&#xA;TimeSpan keepRange = TimeSpan.FromHours(12);&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string daoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;{&#xD;&#xA;    return;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt; latestEntries = new Dictionary&lt;string, KeyValuePair&lt;string, DateTime&gt;&gt;();&#xD;&#xA;&#xD;&#xA;foreach (string entry in entries)&#xD;&#xA;{&#xD;&#xA;    string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    if (parts.Length != 4)&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    if (!DateTime.TryParseExact(parts[3].Trim(), &quot;HH:mm&quot;, null, System.Globalization.DateTimeStyles.None, out DateTime entryTime))&#xD;&#xA;        continue;&#xD;&#xA;&#xD;&#xA;    // 为解析的时间（仅包含时分）添加日期信息&#xD;&#xA;    // 创建基础日期时间（今天的该时间点）&#xD;&#xA;    DateTime entryDateTime = new DateTime(now.Year, now.Month, now.Day, entryTime.Hour, entryTime.Minute, 0);&#xD;&#xA;    &#xD;&#xA;    // 处理跨天情况：如果时间在当前时间之前且超出保留范围，则视为昨天的时间&#xD;&#xA;    if (entryDateTime &gt; now)&#xD;&#xA;    {&#xD;&#xA;        // 如果解析的时间比当前时间晚，说明是昨天的时间&#xD;&#xA;        entryDateTime = entryDateTime.AddDays(-1);&#xD;&#xA;    }&#xD;&#xA;    &#xD;&#xA;    // 计算与当前时间的差值&#xD;&#xA;    TimeSpan timeDiff = now - entryDateTime;&#xD;&#xA;    &#xD;&#xA;    // 只保留在指定时间范围内的数据&#xD;&#xA;    if (timeDiff &gt; keepRange)&#xD;&#xA;    {&#xD;&#xA;        continue;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string groupKey = parts[1];&#xD;&#xA;    if (!latestEntries.ContainsKey(groupKey))&#xD;&#xA;    {&#xD;&#xA;        latestEntries.Add(groupKey, new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime));&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        if (entryDateTime &gt; latestEntries[groupKey].Value)&#xD;&#xA;        {&#xD;&#xA;            latestEntries[groupKey] = new KeyValuePair&lt;string, DateTime&gt;(entry, entryDateTime);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;List&lt;string&gt; result = new List&lt;string&gt;();&#xD;&#xA;foreach (var item in latestEntries.Values)&#xD;&#xA;{&#xD;&#xA;    result.Add(item.Key);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;string processedData = string.Join(&quot;;&quot;, result);&#xD;&#xA;VariableScalar newDaoVar = new VariableScalar&#xD;&#xA;{&#xD;&#xA;    Value = processedData,&#xD;&#xA;    LastChanger = &quot;Mata&quot;,&#xD;&#xA;    LastChanged = DateTime.Now&#xD;&#xA;};&#xD;&#xA;// 安全设置 dao 变量（替换原静态助手写法）&#xD;&#xA;globalVarStore.Scalar[&quot;dao&quot;] = newDaoVar;" />
          <Action OrderNumber="22" Enabled="False" ActionType="Placeholder" Description="计算数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="23" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using System.Linq;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 定义强类型类，替代 dynamic&#xD;&#xA;public class IslandDisplayItem&#xD;&#xA;{&#xD;&#xA;    public string TypeName { get; set; }&#xD;&#xA;    public string IslandId { get; set; }&#xD;&#xA;    public int FirstTime { get; set; }&#xD;&#xA;    public string TimeDisplay { get; set; }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 获取变量存储（全局：true 对应 dao 变量；非全局：false 对应 listtmp/counttmp 变量）&#xD;&#xA;    VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;    VariableStore localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;    // 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;    string daoValue = string.Empty;&#xD;&#xA;    VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;    if (daoVar != null)&#xD;&#xA;    {&#xD;&#xA;        daoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (string.IsNullOrWhiteSpace(daoValue))&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    // 替换 dynamic 列表为强类型列表&#xD;&#xA;    var displayList = new List&lt;IslandDisplayItem&gt;();&#xD;&#xA;    string[] entries = daoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string entry in entries)&#xD;&#xA;    {&#xD;&#xA;        string[] parts = entry.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;        if (parts.Length != 4) continue;&#xD;&#xA;&#xD;&#xA;        string typeCode = parts[0].Trim();&#xD;&#xA;        string islandId = parts[1].Trim();&#xD;&#xA;        if (!int.TryParse(parts[2].Trim(), out int northTime)) continue;&#xD;&#xA;        string lastTime = parts[3].Trim(); // 仍保留读取，仅不拼接&#xD;&#xA;&#xD;&#xA;        string typeName = typeMap.TryGetValue(typeCode, out var name) ? name : &quot;未知&quot;;&#xD;&#xA;&#xD;&#xA;        int southTime = (northTime - 30 + 60) % 60;&#xD;&#xA;        int firstTime = Math.Min(northTime, southTime);&#xD;&#xA;        int secondTime = Math.Max(northTime, southTime);&#xD;&#xA;        &#xD;&#xA;        string firstTimeStr = firstTime.ToString(&quot;D2&quot;);&#xD;&#xA;        string secondTimeStr = secondTime.ToString(&quot;D2&quot;);&#xD;&#xA;        &#xD;&#xA;        // 唯一修改处：移除末尾的 -{lastTime} 拼接&#xD;&#xA;        string timeDisplay = $&quot;{firstTimeStr} ({(firstTime == northTime ? &quot;北&quot; : &quot;南&quot;)}) {secondTimeStr} ({(secondTime == northTime ? &quot;北&quot; : &quot;南&quot;)})&quot;;&#xD;&#xA;&#xD;&#xA;        // 添加强类型对象到列表&#xD;&#xA;        displayList.Add(new IslandDisplayItem&#xD;&#xA;        {&#xD;&#xA;            TypeName = typeName,&#xD;&#xA;            IslandId = islandId,&#xD;&#xA;            FirstTime = firstTime,&#xD;&#xA;            TimeDisplay = timeDisplay&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    if (displayList.Count == 0)&#xD;&#xA;    {&#xD;&#xA;        return;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 按 FirstTime 升序排序&#xD;&#xA;    var sortedList = displayList.OrderBy(item =&gt; item.FirstTime).ToList();&#xD;&#xA;    &#xD;&#xA;    // 计算条目数量&#xD;&#xA;    int itemCount = sortedList.Count;&#xD;&#xA;    &#xD;&#xA;    // 使用回车符连接所有条目为单个字符串&#xD;&#xA;    string listContent = string.Join(Environment.NewLine, sortedList.Select(item =&gt; &#xD;&#xA;        $&quot;{item.TypeName}-{item.IslandId}-{item.TimeDisplay}&quot;));&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 listtmp 变量（非全局）&#xD;&#xA;    VariableScalar listTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = listContent,&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;listtmp&quot;] = listTmpVar;&#xD;&#xA;    &#xD;&#xA;    // 创建并设置 counttmp 变量（存储条目数量，非全局）&#xD;&#xA;    VariableScalar countTmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = itemCount.ToString(),&#xD;&#xA;        LastChanger = &quot;System&quot;,&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    localVarStore.Scalar[&quot;counttmp&quot;] = countTmpVar;&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;}" />
          <Action OrderNumber="24" Enabled="False" ActionType="Placeholder" Description="进岛默语" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="25" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原GetScalarVariable(true)）&#xD;&#xA;static VariableStore _globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 输出方法（简化命名空间前缀，风格统一）&#xD;&#xA;static void OutputIslandInfo(string format, params object[] args)&#xD;&#xA;{&#xD;&#xA;    RealPlugin.plug.InvokeNamedCallback(&quot;command&quot;, $&quot;/e {string.Format(format, args)}&quot;);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 1. 安全获取所有需要的变量（替换原静态助手写法）&#xD;&#xA;    string targetDaolast = string.Empty;&#xD;&#xA;    VariableScalar daolastVar = _globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;    if (daolastVar != null)&#xD;&#xA;    {&#xD;&#xA;        targetDaolast = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string timelastValue = string.Empty;&#xD;&#xA;    VariableScalar timelastVar = _globalVarStore.GetScalarVariable(&quot;timelast&quot;);&#xD;&#xA;    if (timelastVar != null)&#xD;&#xA;    {&#xD;&#xA;        timelastValue = timelastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string arealast = string.Empty;&#xD;&#xA;    VariableScalar arealastVar = _globalVarStore.GetScalarVariable(&quot;arealast&quot;);&#xD;&#xA;    if (arealastVar != null)&#xD;&#xA;    {&#xD;&#xA;        arealast = arealastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 类型映射字典&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    // 处理arealast映射（若不存在则使用原始值）&#xD;&#xA;    string areaType = typeMap.TryGetValue(arealast, out string type) ? type : arealast;&#xD;&#xA;&#xD;&#xA;    // 解析北罐时间&#xD;&#xA;    int northTime = 0;&#xD;&#xA;    bool isNorthTimeValid = int.TryParse(timelastValue, out northTime);&#xD;&#xA;&#xD;&#xA;    // 计算南罐时间&#xD;&#xA;    int southTime = 0;&#xD;&#xA;    if (isNorthTimeValid)&#xD;&#xA;    {&#xD;&#xA;        southTime = (northTime - 30 + 60) % 60; // 简化跨小时处理逻辑&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 计算当前分钟数&#xD;&#xA;    int currentMinute = DateTime.Now.Minute;&#xD;&#xA;&#xD;&#xA;    // 计算最近罐子&#xD;&#xA;    string closestJar = &quot;&quot;;&#xD;&#xA;    if (isNorthTimeValid)&#xD;&#xA;    {&#xD;&#xA;        // 计算北罐剩余分钟（处理跨小时）&#xD;&#xA;        int northDiff = northTime &gt;= currentMinute &#xD;&#xA;            ? northTime - currentMinute &#xD;&#xA;            : (northTime + 60) - currentMinute;&#xD;&#xA;        &#xD;&#xA;        // 计算南罐剩余分钟（处理跨小时）&#xD;&#xA;        int southDiff = southTime &gt;= currentMinute &#xD;&#xA;            ? southTime - currentMinute &#xD;&#xA;            : (southTime + 60) - currentMinute;&#xD;&#xA;        &#xD;&#xA;        // 取最小剩余时间的罐子&#xD;&#xA;        closestJar = northDiff &lt;= southDiff &#xD;&#xA;            ? $&quot;北({northDiff}分钟)&quot; &#xD;&#xA;            : $&quot;南({southDiff}分钟)&quot;;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // 场景化调用（保持原有逻辑）&#xD;&#xA;    if (isNorthTimeValid &amp;&amp; !string.IsNullOrEmpty(targetDaolast) &amp;&amp; targetDaolast != &quot;未知岛屿&quot;)&#xD;&#xA;    {&#xD;&#xA;        OutputIslandInfo(&quot;{0}:{1}-北:{2}分-南:{3}分-{4}&quot;, &#xD;&#xA;                       areaType, targetDaolast, northTime, southTime, closestJar);&#xD;&#xA;    }&#xD;&#xA;    else if (!isNorthTimeValid &amp;&amp; !string.IsNullOrEmpty(targetDaolast) &amp;&amp; targetDaolast != &quot;未知岛屿&quot;)&#xD;&#xA;    {&#xD;&#xA;        OutputIslandInfo(&quot;{0}:{1}-北:未知-南:未知&quot;, &#xD;&#xA;                       areaType, targetDaolast);&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        OutputIslandInfo(&quot;{0}:未知岛屿-北:未知-南:未知&quot;, &#xD;&#xA;                       areaType);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    OutputIslandInfo(&quot;获取岛屿信息失败：{0}&quot;, ex.Message);&#xD;&#xA;}" />
          <Action OrderNumber="26" ActionType="Trigger" TriggerId="7e3bde11-e150-4b7c-912a-ae500c9806ab" TriggerForce="regexp,conditions,active" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="a7f5f940-2bb3-4b66-8cdf-4acf7603929a" Name="3b.关闭悬浮窗" RegularExpression="^.{15}\S+ 00:0038::dc$">
        <Actions>
          <Action OrderNumber="1" ActionType="TextAura" TextAuraOp="DeactivateAura" TextAuraAlignment="TopLeft" TextAuraEffect="Bold" TextAuraFontSize="24" TextAuraName="dao" TextAuraExpression="${v:texttmp}" TextAuraXIniExpression="0" TextAuraYIniExpression="0" TextAuraWIniExpression="800" TextAuraHIniExpression="40" TextAuraOIniExpression="100" TextAuraFontName="宋体" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="7530fae2-d683-4870-b8d2-e5e1ab39f062" Name="3a.打开悬浮窗" RegularExpression="^.{15}\S+ 00:0038::cd$">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="输出信息" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="TextAura" TextAuraAlignment="TopCenter" TextAuraFontSize="12" TextAuraForeground="#FFC107" TextAuraBackground="#00000000" TextAuraOutline="#000" TextAuraName="dao" TextAuraExpression="${v:dtmp}&#xD;&#xA;${v:listtmp}" TextAuraXIniExpression="0" TextAuraYIniExpression="400" TextAuraWIniExpression="280" TextAuraHIniExpression="18*(${v:counttmp}+1)" TextAuraOIniExpression="100" TextAuraHTickExpression="18*(${v:counttmp}+1)" TextAuraFontName="仿宋" />
        </Actions>
      </Trigger>
      <Trigger Enabled="true" Id="7e3bde11-e150-4b7c-912a-ae500c9806ab" Name="0b.更新数据" RefirePeriodExpression="1000" Sequential="True">
        <Actions>
          <Action OrderNumber="1" Enabled="False" ActionType="Placeholder" Description="处理罐子时间（已有数据情况）" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="2" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 获取全局变量存储（对应原Get/SetScalarVariable(true)，非全局则改为false）&#xD;&#xA;VariableStore globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;&#xD;&#xA;// 1. 安全获取 dao 变量（替换原静态助手写法）&#xD;&#xA;string currentDaoValue = string.Empty;&#xD;&#xA;VariableScalar daoVar = globalVarStore.GetScalarVariable(&quot;dao&quot;);&#xD;&#xA;if (daoVar != null)&#xD;&#xA;{&#xD;&#xA;    currentDaoValue = daoVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;// 2. 安全获取 daolast 变量（替换原静态助手写法）&#xD;&#xA;string targetDaolast = string.Empty;&#xD;&#xA;VariableScalar daolastVar = globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;if (daolastVar != null)&#xD;&#xA;{&#xD;&#xA;    targetDaolast = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;if (!string.IsNullOrEmpty(currentDaoValue) &amp;&amp; !string.IsNullOrEmpty(targetDaolast))&#xD;&#xA;{&#xD;&#xA;    string[] daoRecords = currentDaoValue.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries);&#xD;&#xA;    &#xD;&#xA;    foreach (string record in daoRecords)&#xD;&#xA;    {&#xD;&#xA;        string[] recordParts = record.Split(new[] { ',' }, StringSplitOptions.None);&#xD;&#xA;        &#xD;&#xA;        if (recordParts.Length &gt;= 4 &amp;&amp; recordParts[1] == targetDaolast)&#xD;&#xA;        {&#xD;&#xA;            if (!string.IsNullOrEmpty(recordParts[2]))&#xD;&#xA;            {&#xD;&#xA;                var timelastVar = new VariableScalar&#xD;&#xA;                {&#xD;&#xA;                    Value = recordParts[2],&#xD;&#xA;                    LastChanger = &quot;Mata&quot;,&#xD;&#xA;                    LastChanged = DateTime.Now&#xD;&#xA;                };&#xD;&#xA;                // 3. 安全设置 timelast 变量（替换原静态助手写法）&#xD;&#xA;                globalVarStore.Scalar[&quot;timelast&quot;] = timelastVar;&#xD;&#xA;            }&#xD;&#xA;            break;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}" />
          <Action OrderNumber="3" Enabled="False" ActionType="Placeholder" Description="计算数据" DescBgColor="0ff" DescTextColor="000" DescriptionOverride="True" />
          <Action OrderNumber="4" ActionType="ExecuteScript" ExecScriptExpression="using System;&#xD;&#xA;using System.Collections.Generic;&#xD;&#xA;using Triggernometry;&#xD;&#xA;using Triggernometry.Core;&#xD;&#xA;using Triggernometry.Core.Variables;&#xD;&#xA;&#xD;&#xA;// 1. 全局变量仓库（读取 daolast、timelast、arealast）&#xD;&#xA;static VariableStore _globalVarStore = RealPlugin.Instance.GetVariableStore(true);&#xD;&#xA;// 2. 局部变量仓库（专门操作 dtmp，对应 GetVariableStore(false)）&#xD;&#xA;static VariableStore _localVarStore = RealPlugin.Instance.GetVariableStore(false);&#xD;&#xA;&#xD;&#xA;// 输出方法修改：写入 局部仓库 的 dtmp 变量&#xD;&#xA;static void OutputIslandInfo(string format, params object[] args)&#xD;&#xA;{&#xD;&#xA;    // 1. 格式化最终要写入的字符串&#xD;&#xA;    string finalContent = string.Format(format, args);&#xD;&#xA;    &#xD;&#xA;    // 2. 参照示例创建 VariableScalar 实例并赋值&#xD;&#xA;    var dtmpVar = new VariableScalar&#xD;&#xA;    {&#xD;&#xA;        Value = finalContent,&#xD;&#xA;        LastChanger = &quot;Mata&quot;, // 保持和示例一致的修改者名称，可根据需要调整&#xD;&#xA;        LastChanged = DateTime.Now&#xD;&#xA;    };&#xD;&#xA;    &#xD;&#xA;    // 3. 安全设置 dtmp 变量（直接通过 Scalar 索引器赋值，自动创建/更新）&#xD;&#xA;    _localVarStore.Scalar[&quot;dtmp&quot;] = dtmpVar;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    // 以下原有逻辑完全不变（仍从全局仓库读取变量）&#xD;&#xA;    string targetDaolast = string.Empty;&#xD;&#xA;    VariableScalar daolastVar = _globalVarStore.GetScalarVariable(&quot;daolast&quot;);&#xD;&#xA;    if (daolastVar != null)&#xD;&#xA;    {&#xD;&#xA;        targetDaolast = daolastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string timelastValue = string.Empty;&#xD;&#xA;    VariableScalar timelastVar = _globalVarStore.GetScalarVariable(&quot;timelast&quot;);&#xD;&#xA;    if (timelastVar != null)&#xD;&#xA;    {&#xD;&#xA;        timelastValue = timelastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    string arealast = string.Empty;&#xD;&#xA;    VariableScalar arealastVar = _globalVarStore.GetScalarVariable(&quot;arealast&quot;);&#xD;&#xA;    if (arealastVar != null)&#xD;&#xA;    {&#xD;&#xA;        arealast = arealastVar.Value?.ToString() ?? string.Empty;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    Dictionary&lt;string, string&gt; typeMap = new Dictionary&lt;string, string&gt;&#xD;&#xA;    {&#xD;&#xA;        {&quot;1&quot;, &quot;鸟&quot;}, {&quot;2&quot;, &quot;猪&quot;}, {&quot;3&quot;, &quot;猫&quot;}, {&quot;4&quot;, &quot;狗&quot;}&#xD;&#xA;    };&#xD;&#xA;&#xD;&#xA;    string areaType = typeMap.TryGetValue(arealast, out string type) ? type : arealast;&#xD;&#xA;&#xD;&#xA;    int northTime = 0;&#xD;&#xA;    bool isNorthTimeValid = int.TryParse(timelastValue, out northTime);&#xD;&#xA;&#xD;&#xA;    int southTime = 0;&#xD;&#xA;    if (isNorthTimeValid)&#xD;&#xA;    {&#xD;&#xA;        southTime = (northTime - 30 + 60) % 60;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    int currentMinute = DateTime.Now.Minute;&#xD;&#xA;&#xD;&#xA;    string closestJar = &quot;&quot;;&#xD;&#xA;    if (isNorthTimeValid)&#xD;&#xA;    {&#xD;&#xA;        int northDiff = northTime &gt;= currentMinute &#xD;&#xA;            ? northTime - currentMinute &#xD;&#xA;            : (northTime + 60) - currentMinute;&#xD;&#xA;        &#xD;&#xA;        int southDiff = southTime &gt;= currentMinute &#xD;&#xA;            ? southTime - currentMinute &#xD;&#xA;            : (southTime + 60) - currentMinute;&#xD;&#xA;        &#xD;&#xA;        closestJar = northDiff &lt;= southDiff &#xD;&#xA;            ? $&quot;北({northDiff}分钟)&quot; &#xD;&#xA;            : $&quot;南({southDiff}分钟)&quot;;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // -------------------------- 关键修改：统一输出格式（冒号改短横线） --------------------------&#xD;&#xA;    if (isNorthTimeValid &amp;&amp; !string.IsNullOrEmpty(targetDaolast) &amp;&amp; targetDaolast != &quot;未知岛屿&quot;)&#xD;&#xA;    {&#xD;&#xA;        // 格式修改：{0}:{1} → {0}-{1}&#xD;&#xA;        OutputIslandInfo(&quot;{0}-{1}-北:{2}分-南:{3}分-{4}&quot;, &#xD;&#xA;                       areaType, targetDaolast, northTime, southTime, closestJar);&#xD;&#xA;    }&#xD;&#xA;    else if (!isNorthTimeValid &amp;&amp; !string.IsNullOrEmpty(targetDaolast) &amp;&amp; targetDaolast != &quot;未知岛屿&quot;)&#xD;&#xA;    {&#xD;&#xA;        // 格式修改：{0}:{1} → {0}-{1}，保持风格统一&#xD;&#xA;        OutputIslandInfo(&quot;{0}-{1}-北:未知-南:未知&quot;, &#xD;&#xA;                       areaType, targetDaolast);&#xD;&#xA;    }&#xD;&#xA;    else&#xD;&#xA;    {&#xD;&#xA;        // 格式保持简洁，与整体风格一致&#xD;&#xA;        OutputIslandInfo(&quot;{0}-未知岛屿-北:未知-南:未知&quot;, &#xD;&#xA;                       areaType);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;catch (Exception ex)&#xD;&#xA;{&#xD;&#xA;    // 异常信息格式不变&#xD;&#xA;    OutputIslandInfo(&quot;获取岛屿信息失败：{0}&quot;, ex.Message);&#xD;&#xA;}" />
          <Action OrderNumber="5" ActionType="Trigger" ExecutionDelayExpression="5000" TriggerId="7e3bde11-e150-4b7c-912a-ae500c9806ab" TriggerForce="regexp,conditions" />
        </Actions>
      </Trigger>
    </Triggers>
  </ExportedFolder>
</TriggernometryExport>